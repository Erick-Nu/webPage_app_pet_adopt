<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmación | PetAdopt</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background: #FFF3E0; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: #FF9800; margin-bottom: 10px; }
        p { color: #555; margin-bottom: 20px; }
        .hidden { display: none; }
        .btn { padding: 12px 24px; background: #FF9800; color: white; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #FF9800; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="card">
        <div id="loadingState">
            <div class="loader"></div>
            <h1>Verificando...</h1>
            <p>Estamos confirmando tu cuenta.</p>
        </div>

        <div id="successState" class="hidden">
            <h1 style="color: #4CAF50;">¡Correo Confirmado!</h1>
            <p id="message">Tu cuenta ha sido activada.<br>Ya puedes iniciar sesión en la App.</p>
            <button onclick="redirectToHome()" class="btn">Volver al Inicio</button>
        </div>

        <div id="errorState" class="hidden">
            <h1 style="color: #F44336;">Error</h1>
            <p id="errorMsg">El enlace no es válido.</p>
            <button onclick="redirectToHome()" class="btn" style="background:#757575">Ir al Inicio</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/app.js"></script>

    <script>
        window.onload = async () => {
            const loadingState = document.getElementById('loadingState');
            const successState = document.getElementById('successState');
            const errorState = document.getElementById('errorState');
            const errorMsg = document.getElementById('errorMsg');

            try {
                // 1. Iniciar Supabase
                const supabase = await getSupabase();
                if (!supabase) throw new Error("Error de conexión.");

                // 2. Configurar listener para cambios de autenticación
                supabase.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' || event === 'USER_UPDATED') {
                        // Mostrar mensaje de éxito al usuario
                        document.getElementById('message').innerText = "¡Correo verificado con éxito! Volviendo a la app...";
                        
                        // Esperar 2 segundos para que el usuario lea el mensaje
                        setTimeout(() => {
                            // Redirección a la app móvil usando deep link
                            window.location.href = "petadopt://login-callback";
                        }, 2000);
                    }
                });

                // 3. Obtener parámetros URL
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                const errorDesc = params.get('error_description');

                if (errorDesc) throw new Error("El enlace ha expirado.");
                if (!code) throw new Error("Enlace incompleto.");

                // 4. Canjear el código (Igual que en reset password)
                const { error } = await supabase.auth.exchangeCodeForSession(code);

                if (error) throw error;

                // 5. Éxito
                loadingState.style.display = 'none';
                successState.classList.remove('hidden');

            } catch (err) {
                loadingState.style.display = 'none';
                errorMsg.textContent = err.message || "No se pudo confirmar.";
                errorState.classList.remove('hidden');
            }
        };
    </script>
</body>
</html>